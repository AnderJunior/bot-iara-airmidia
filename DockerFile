# syntax=docker/dockerfile:1

# =========================
# 1) Build (TypeScript)
# =========================
FROM node:22-alpine AS build
WORKDIR /app

# Instala dependências (cache eficiente)
COPY package*.json ./
RUN npm ci

# Copia o restante do código e compila
COPY . .
RUN npm run build

# =========================
# 2) Runtime (produção)
# =========================
FROM node:22-alpine AS runtime
WORKDIR /app
ENV NODE_ENV=production

# Instala somente dependências de produção
COPY package*.json ./
RUN npm ci --omit=dev

# Copia o build gerado
COPY --from=build /app/build ./build

# Se o runtime precisar de outros arquivos (ex.: constants.json)
# (o seu projeto tem constants.json na raiz)
COPY --from=build /app/constants.json ./constants.json

# Porta do seu Fastify/HTTP (se usar). Se não usar HTTP, pode manter.
EXPOSE 8080

# Inicia o bot (seu package.json usa "start": "node .")
CMD ["node", "."]